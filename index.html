<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TeleGraffiti AR</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js'></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass { background: rgba(20, 20, 20, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .radar-pulse { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; background: #00ff88; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); } 100% { box-shadow: 0 0 0 20px rgba(0,0,0,0); } }
    </style>
</head>
<body style="margin: 0; overflow: hidden; background: #000;">

    <!-- UI ИНТЕРФЕЙС -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black text-white">
        <h1 class="text-3xl font-bold font-mono text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600">TeleGraffiti</h1>
        <p class="text-gray-500 mt-2 text-sm">AR SYSTEM v1.0</p>
        <button onclick="startAR()" class="mt-8 px-8 py-3 bg-white text-black font-bold rounded-full hover:scale-105 transition">START SYSTEM</button>
    </div>

    <div id="hud" class="fixed inset-0 z-40 pointer-events-none hidden">
        <div class="absolute top-4 left-4 right-4 flex justify-between">
            <div class="glass text-white px-4 py-2 rounded-full flex gap-2 pointer-events-auto">
                <i class="fa-solid fa-cube text-purple-400"></i> <span id="score">0</span> pts
            </div>
            <div class="glass text-white w-10 h-10 rounded-full flex items-center justify-center pointer-events-auto" onclick="Telegram.WebApp.close()">✖</div>
        </div>
        
        <div class="absolute bottom-10 w-full flex justify-center gap-4 px-4 pointer-events-auto">
            <button onclick="spawnDemo()" class="glass text-white py-3 px-6 rounded-xl w-full active:bg-white/20 transition">
                <i class="fa-solid fa-bug"></i> ТЕСТ: Спавн тут
            </button>
        </div>
        
        <div class="absolute bottom-28 w-full text-center"><span id="debug" class="text-xs text-green-400 bg-black/50 px-2">Waiting for GPS...</span></div>
    </div>

    <!-- AR СЦЕНА -->
    <a-scene vr-mode-ui="enabled: false" embedded arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false;'>
        <a-camera gps-camera rotation-reader>
            <a-cursor visible="false"></a-cursor>
        </a-camera>
    </a-scene>

    <script>
        let score = 0;
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        function startAR() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('hud').classList.remove('hidden');
            initGPS();
        }

        function initGPS() {
            if(!navigator.geolocation) return;
            navigator.geolocation.watchPosition(
                (pos) => {
                    document.getElementById('debug').innerText = `GPS: ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
                },
                (err) => alert("Включи GPS!"), {enableHighAccuracy: true}
            );
        }

        // Спавнит куб прямо перед лицом (для теста, если GPS глючит)
        function spawnDemo() {
            const scene = document.querySelector('a-scene');
            const box = document.createElement('a-box');
            box.setAttribute('material', 'color: #8b5cf6; opacity: 0.9');
            box.setAttribute('scale', '1 1 1');
            box.setAttribute('position', '0 0 -3'); // 3 метра перед камерой
            box.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000');
            
            // Клик по кубу
            box.addEventListener('click', () => {
                box.setAttribute('visible', 'false');
                score += 100;
                document.getElementById('score').innerText = score;
                tg.HapticFeedback.notificationOccurred('success');
            });

            scene.appendChild(box);
            tg.HapticFeedback.impactOccurred('heavy');
        }
    </script>
</body>
</html>